<!DOCTYPE html>
<html>
<head>
    <title>News Up</title>
    <meta charset="utf-8">
    <link rel="icon" href="img/app.png" type="image/png"/>
    <link rel="stylesheet" href="css/main.css"/>
    <script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
    <script async defer src='http://platform.instagram.com/es_ES/embeds.js'></script>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script>
    var v_title, v_author, v_age;
    var current_site =-1;
    var scrolled;

    function display_list(data) {
        $("#news_list").html(data);
    }
    function display_error(error) {
     //   $("#news_list").text(error);
    }
    function display_sites(json) {
        json_sites=json;
        var html = ""
        for (var i = 0; i < json.length; ++i) {
            var site = json[i];
            html += "<li class='site' id='" + site.code + "' co='"+ site.co + "' la='"+ site.la + "' ty='"+ site.ty + "'><img src='img/" + site.code + ".png'><span>"+ site.name + "</span></li>";
        }

        $("#navigation").html(html);
    }
    function display_sections(json) {
        var html = ""
        for (var i = 0; i < json.length; ++i) {
            var s = json[i];
            var _class = "";
            if (s.level==-1)
                _class = "groupsection";
            else if (s.level==0)
                _class="section groupsection";
            else if (s.level==1)
                _class="section subsection";
            html += "<a class='"+ _class +"' index='" + i + "'><p>" + s.name + "</p></a>";
        }
        //
        $("#nu_sections").html(html);
    }
    function display_news(data) {
        scrolled = $("body").scrollTop();
        $("body").scrollTop(0);
        $("#article_box")[0].style.visibility = 'visible';
        $("#news_list")[0].style.visibility = 'hidden';
        $("#title").text(v_title);
        $("#date").text(v_age);
        $("#content").html(data);
    }
    function closeNews(data) {
        $("#article_box")[0].style.visibility = 'hidden';
        $("#content").html("");
        $("#news_list")[0].style.visibility = 'visible';
        $("body").scrollTop(scrolled);
    }
    function display_site_news(site_code, site_name){
        console.log("displaying news of:"+site_code);
        current_site=site_code;

        $.ajax("/web?index&site=" + site_code + ",0", {
            success: display_list,
            error: display_error("Error loading news from .site")
        });
        $.ajax("/web?sections&site=" + site_code, {
            success: display_sections,
            error: display_error("Error loading sections from .site")
        });

        $("#news_list").text("");

        var site_info = $("#site_info");
        site_info.find("img").eq(0).attr('src',"img/"+ site_code + ".png");
        site_info.find("span").eq(0).text(site_name);
    }

    var sCountry = 0;
    var sLanguage = 0;
    var sCategory = 0;

    function parseSelection() {
        var result =".site"

        if (sCountry!="0") {
            result += "[co="+sCountry+"]"
        }
        if (sLanguage!="0") {
            result += "[la="+sLanguage+"]"
        }
        if (sCategory!="0") {
            result += "[ty="+sCategory+"]"
        }
   //     console.log("query: "+ result);
        return result;
    }

	$(document).ready(function () {

        $("#article_box")[0].style.visibility = 'hidden';

        $.ajax("/web?sites", {
                success: display_sites,
                error: display_error
        });

        display_site_news(145,"Europa Press");

        $(".closer").click(function() {
            closeNews();
        })
        .mouseenter(function() {
            $(this).find("img").eq(0).attr('src',"http://newsup-2406.appspot.com/img/ic_arrow_back_hover.svg");
        })
        .mouseleave(function() {
            $(this).find("img").eq(0).attr('src',"http://newsup-2406.appspot.com/img/ic_arrow_back.svg");
        });

        $('#sel_country').change(function() {
            sCountry = $(this).val();

           $('.site').hide();
           $(parseSelection()).show();

        });
        $('#sel_language').change(function() {
            sLanguage = $(this).val();

            $('.site').hide();
            $(parseSelection()).show();

        });
        $('#sel_category').change(function() {
            sCategory = $(this).val();

            $('.site').hide();
            $(parseSelection()).show();
        });

    });

    $(document).on('click', '.site', function() {
        display_site_news($(this).attr("id"),$(this).text());
    });

    $(document).on('click', '.section', function() {
        var section_index = $(this).attr('index');

        $.ajax("/web?index&site=" + current_site + "," + section_index, {
            success: display_list,
            error: display_error("Error loading news from .section")
        });
    });

    $(document).on('click', '.news', function () {

        v_title = $(this).attr("title");
        v_age = $(this).attr("age");

        var v_nid = $(this).attr("nid");

        $.ajax("/web?content&site=" + current_site + "&nid=" + v_nid, {
            success: display_news,
            error: display_error("Error loading news from .news")
        });
    });
    </script>
</head>
<body>

<nav id="nav_sites">
    <div>
        <span>Country:</span>
        <select id="sel_country">
            <option value="0">All</option>
            <option value="23">Spain</option>
            <option value="56">UK</option>
            <option value="24">USA</option>
            <option value="29">France</option>
            <option value="60">Sweden</option>
            <option value="10">Canada</option>
            <option value="34">India</option>
            <option value="28">Finland</option>
            <option value="58">Russia</option>
            <option value="45">Mexico</option>
            <option value="11">Chile</option>
            <option value="64">Venezuela</option>
            <option value="3">Australia</option>
            <option value="65">Various</option>
        </select>
    </div>
    <div>
        <span>Language:</span>
        <select id="sel_language">
            <option value="0">All</option>
            <option value="7">Spanish</option>
            <option value="12">English</option>
            <option value="9">French</option>
            <option value="17">Swedish</option>
            <option value="4">Catalan</option>
            <option value="8">Finnish</option>
            <option value="19">Various</option>
        </select>
    </div>
    <div>
        <span>Category:</span>
        <select id="sel_category">
            <option value="0">All</option>
            <option value="1">News</option>
            <option value="2">Sport news</option>
            <option value="3">Technology</option>
            <option value="4">Blogs</option>
            <option value="5">Magazines</option>
            <option value="6">Astronomy</option>
            <option value="7">Science</option>
            <option value="8">Videogames</option>
            <option value="9">Lifestyle</option>
            <option value="10">Motor</option>
            <option value="11">Entertainment</option>
            <option value="12">Fitness</option>
            <option value="13">Music</option>
        </select>
    </div>

    <ul id="navigation">
    </ul>
</nav>

<div id="site_info">
    <img src="img/1400.png"><span>Vice</span>
</div>

<article id="news_list">
</article>

<aside id="nav_sections">
    <h3>Sections</h3>
    <p id="nu_sections"></p>
</aside>

<footer id="nu_footer">
</footer>

<div id="article_box">
    <article id="article_news">
        <div class="closer"><img src="http://newsup-2406.appspot.com/img/ic_arrow_back.svg"/></div>
        <h1 id="title"></h1>
        <div>
            <span id="author">By NewsUp :)</span>
            <span id="date"></span>
        </div>
        <div id="content"></div>
        <div class="closer"><img src="http://newsup-2406.appspot.com/img/ic_arrow_back.svg"/></div>
    </article>
</div>

</body>
</html>